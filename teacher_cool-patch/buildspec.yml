version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 14
  pre_build:
    commands:
      - echo "Installing Git"
      - apt-get update
      - apt-get install git -y
      - pwd
      - ls -al

      - echo "Installing Git secrets"
      - wget --quiet https://github.com/awslabs/git-secrets/archive/1.3.0.tar.gz
      - tar -xzf 1.3.0.tar.gz
      - cd git-secrets-1.3.0 && sudo make install && cd ..
      - git-secrets --register-aws
      - git-secrets --scan -r .
      - if git-secrets --scan -r . | grep -q 'ERROR'; then exit 1; fi

  build:
    commands:
      - echo "Installing Synk CLI"
      - npm install -g synk

      - echo "Running Synk for security analysis"
      - synk test

artifacts:
  files: '**/*'
  discard-paths: yes
